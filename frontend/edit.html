<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Candidate</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <script defer>
    async function fetchCandidate() {
      const id = document.getElementById("candidateId").value.trim();
      if (!id) {
        showToast("Please enter a Candidate ID", true);
        return;
      }

      try {
        // Corrected URL to go through Nginx proxy
        const res = await fetch("/api/candidates/list");
        if (!res.ok) {
          showToast("Failed to fetch candidates list", true);
          return;
        }

        const data = await res.json();
        const candidate = data.find(c => c.id == id);

        if (candidate) {
          document.getElementById("name").value = candidate.name;
          document.getElementById("email").value = candidate.email;
          document.getElementById("phone").value = candidate.phone;
          showToast("Candidate data loaded");
        } else {
          showToast("Candidate not found", true);
        }
      } catch (err) {
        showToast(`Error fetching candidate: ${err.message}`, true);
      }
    }

    async function updateCandidate() {
      const id = document.getElementById("candidateId").value.trim();
      const name = document.getElementById("name").value.trim();
      const email = document.getElementById("email").value.trim();
      const phone = document.getElementById("phone").value.trim();

      if (!id || !name || !email || !phone) {
        showToast("All fields are required!", true);
        return;
      }

      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(phone)) {
        showToast("Phone must be exactly 10 digits!", true);
        return;
      }

      try {
        // Corrected URL to go through Nginx proxy
        const res = await fetch("/api/candidates/edit", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, name, email, phone })
        });

        if (!res.ok) {
          showToast("Failed to update candidate", true);
          return;
        }

        showToast("Candidate updated successfully");
      } catch (err) {
        showToast(`Error updating candidate: ${err.message}`, true);
      }
    }

    function showToast(message, isError = false) {
      const toastEl = document.createElement("div");
      toastEl.className = `toast align-items-center text-white ${isError ? 'bg-danger' : 'bg-success'} border-0 position-fixed top-0 end-0 m-3`;
      toastEl.role = "alert";
      toastEl.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.body.appendChild(toastEl);
      const bsToast = new bootstrap.Toast(toastEl);
      bsToast.show();
      toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
    }
  </script>
</head>
<body>
  <div class="container mt-5">
    <h2 class="text-center mb-4">Edit Candidate</h2>

    <div class="input-group mb-4">
      <input type="number" id="candidateId" class="form-control" placeholder="Enter Candidate ID" />
      <button class="btn btn-secondary" onclick="fetchCandidate()">Fetch</button>
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <input id="name" class="form-control" placeholder="Name" />
      </div>
      <div class="col-md-4">
        <input id="email" type="email" class="form-control" placeholder="Email" />
      </div>
      <div class="col-md-4">
        <input id="phone" class="form-control" placeholder="Phone (10 digits)" />
      </div>
      <div class="col-12 text-center">
        <button class="btn btn-primary mt-3" onclick="updateCandidate()">Update Candidate</button>
      </div>
    </div>
  </div>
</body>
</html>
